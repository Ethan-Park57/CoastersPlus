---
title: "Final Project"
output: html_document
author: "Ethan Park, Evan Wu, Priyanka Kaul"
date: "28 July, 2023"
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("Data.R")
```

```{r Libraries, message = FALSE, echo = FALSE}
library(tidyverse)
library(readxl)
library(patchwork)
library(kableExtra)
library(knitr)
library(ranger)
library(vip)
library(rpart)
library(rpart.plot)
library(gridExtra)
library(caret)

set.seed(13*38*51)
```

<br>
<br>

#### MLB Population Averages (2020 - 2022)
##### Note Recategorizations: 

##### *"Sliders" includes Slurves and Sweepers*

##### *"Curveballs" includes Knuckle Curves*

##### *"Changeup" includes Splitters*

<br>

```{r League Movement, warning = FALSE, message = FALSE, echo = FALSE}
results <- pitches %>% 
  select(-c(pos3_int_start_distance:pos9_int_start_distance))

movement <- Data %>% 
  select(pitch_type, pitch_type_name, Stuff, `Stf+ Pitch`:tail, 
         avg_speed, pitches_thrown, pitch_per, spin_rate, playerID) %>% 
  rename(pitch_prop = pitch_per) %>% 
  filter(!is.na(`Stf+ Pitch`))

league <- movement %>% 
  group_by(pitch_type_name) %>% 
  summarize("horizontal" = 
              weighted.mean(pitcher_break_x, pitches_thrown),
            "vertical" = 
              weighted.mean(pitcher_break_z, pitches_thrown),
            "prop" =  
              weighted.mean(pitch_prop, pitches_thrown),
            "spin" =  
              weighted.mean(spin_rate, pitches_thrown, na.rm = TRUE)) %>% 
  as.data.frame()
  
league %>% 
  kable(digits = 2, align = "c",
        col.names = c("Pitch", "Horizontal", "Vertical",
                      "Pitch Proportion", "Spin Rate")) %>% 
  kable_styling(full_width = T)
```

```{r Stuff+ Histogram, echo = FALSE, warning = FALSE}
movement %>% 
  filter(pitch_type == "CU") %>% 
  ggplot() +
  geom_histogram(aes(x = Stuff),
                 color = "white", fill = "darkgray", binwidth = 2) +
  labs(x = "Stuff+", y = "",
       title = "Stuff+ (By Pitcher)") +
  xlim(75, 200) + ylim(0, 15) +
  theme_classic() + theme(plot.title = element_text(hjust = 0.5)) +
  movement %>% 
  filter(pitch_type == "CU") %>% 
  ggplot() +
  geom_histogram(aes(x = `Stf+ Pitch`), 
                 color = "white", fill = "lightgreen", binwidth = 2) +
  labs(x = "Stuff+", y = "",
       title = "Stuff+ (By Pitch)") +
  xlim(75, 200) + ylim(0, 15) +
  theme_classic() + theme(plot.title = element_text(hjust = 0.5))
```

```{r Classification Table, echo = FALSE, eval = FALSE}
Stf_Class <- c("< 55", "< 70", "< 85", "< 95", " < 105", 
              "< 115", "< 130", "< 145", "< 160", "â‰¥ 160") %>% 
  cbind(1:10) %>% 
  as.data.frame()

names(Stf_Class) <- c("Stf+ Range", "Class")
Stf_Class <- Stf_Class %>% 
  select(Class, `Stf+ Range`)

stf_class_tbl <- ggplot() +
  theme_void() +
  annotate(geom = "table",
           x = 2, y = 11,
           label = list(Stf_Class))

movement <- movement %>% 
  mutate(pitch_class = 
           case_when(
             `Stf+ Pitch` < 55 ~ 1,
             `Stf+ Pitch` < 70 ~ 2,
             `Stf+ Pitch` < 85 ~ 3,
             `Stf+ Pitch` < 95 ~ 4,
             `Stf+ Pitch` < 105 ~ 5,
             `Stf+ Pitch` < 115 ~ 6,
             `Stf+ Pitch` < 130 ~ 7,
             `Stf+ Pitch` < 145 ~ 8,
             `Stf+ Pitch` < 160 ~ 9,
             `Stf+ Pitch` >= 160 ~ 10))

stf_class_g <- movement %>% 
  group_by(pitch_class) %>% 
  summarize(Count = n()) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = pitch_class, y = Count)) + 
  geom_col(color = "black", fill = "forestgreen") +
  geom_label(aes(label = Count), vjust = -0.5,
             color = "forestgreen", fill = "lightgrey", size = 3.5) +
  scale_x_continuous(breaks = seq(1, 10, 1)) +
  scale_y_continuous(breaks = seq(0, 600, 100), limits = c(0, 600)) +
  theme_classic() +
  labs(x = "Pitch Classification",
       y = "") +
  NULL


stf_class_g + stf_class_tbl

```

```{r Speed Differential, echo = FALSE, warning = FALSE, message = FALSE}
g_sd1 <- Data2 %>% 
  filter(speed_diff < 0) %>% 
  ggplot(aes(x = speed_diff, y = `Stf+ Pitch`)) +
  theme(panel.background = element_rect("black"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line("darkgray")) +
  geom_hline(yintercept = 100, color = "green", size = 1.25, alpha = 0.3) +
  geom_point(shape = 18, size = 2, alpha = 0.8, aes(color = avg_speed)) +
  geom_smooth(se = FALSE, color = "gray92", size = 1.5) +
  labs(x = "",
       y = "Pitch Stuff+",
       color = "Pitch Speed",
       title = "Stuff+ by Speed Differential & Pitch Type") +
  scale_color_gradient(low = "yellow", high = "red", limits = c(70, 100)) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.title = element_text(hjust = 0.5)) +
  scale_x_reverse()

g_sd2 <- Data2 %>% 
  filter(speed_diff < 0) %>% 
  ggplot(aes(x = speed_diff, y = `Stf+ Pitch`)) +
  theme(panel.background = element_rect("black"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line("darkgray")) +
  geom_hline(yintercept = 100, color = "yellow", size = 1, alpha = 0.5) +
  geom_point(shape = 18, size = 2, alpha = 0.8, aes(color = pitch_type_name)) +
  geom_smooth(se = FALSE, color = "gray92", size = 1.5) +
  labs(y = "Pitch Stuff+",
       x = "Speed Differential (vs. Fastball)",
       color = "Pitch") +
  theme(legend.title = element_text(hjust = 0.5)) +
  scale_x_reverse()

g_sd1 / g_sd2
```

```{r Pitch Prop, echo = FALSE, warning = FALSE, message = FALSE}
Data2 %>% 
  ggplot(aes(x = `Stf+ Pitch`, y = (pitch_per-league$prop)/league$prop,
             color = woba)) +
  theme(panel.background = element_rect("black"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line("darkgray")) +
  geom_hline(yintercept = 0, color = "yellow", size = 1, alpha = 0.7) +
  geom_vline(xintercept = 100, color = "yellow", size = 1, alpha = 0.7) +
  geom_point(alpha = 0.8) +
  geom_smooth(se = FALSE, color = "gray92", size = 1.5) +
  labs(x = "Pitch Stuff+",
       y = "Pitch Usage (vs. League Average)",
       color = "wOBA") +
  scale_color_gradient(low = "green", high = "red") +
  scale_y_continuous(limits = c(-1,2.5), labels = scales::percent) +
  NULL

```

```{r Tree of Component Variables, echo = FALSE}
# Lots of Variables
tree_input <- Data2 %>% 
  select(Name, year, pitch_hand:Stuff, `Stf+ Pitch`, pitcher_break_z,
         pitcher_break_x, avg_speed, spin_rate, pitches_thrown, pitch_per,
         run_value:hard_hit_percent, fb_type:speed_diff) %>% 
  filter(!is.na(`Stf+ Pitch`), !is.na(run_value), !is.na(spin_rate),
         !is.na(fb_stuff), !is.na(fb_speed), !is.na(fb_thrown),
         !is.na(speed_diff)) %>% 
  select(-Name:-pitch_type_name, -fb_type) %>% 
  rename(pitch_stuff = `Stf+ Pitch`) %>% 
  select(-est_woba, -slg, -ba, -rv100, -run_value, -est_slg,
         -est_ba)

model_data_full <- tree_input %>% 
  select(woba, pitch_stuff, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate,
         pitch_per, fb_stuff, fb_thrown, speed_diff) %>% 
  filter(speed_diff != 0)


rpart(formula =woba ~ pitch_stuff + pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate + pitch_per + fb_stuff + fb_thrown + 
                  speed_diff,
     data = model_data_full, method = "anova") %>%
  rpart.plot()


# Fewer Variables
model_data_reduced <- tree_input %>% 
  select(woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, 
         speed_diff) %>% 
  filter(speed_diff != 0) %>% 
  select(-speed_diff)

model_reduced <- ranger(woba ~ ., data = model_data_reduced, num.trees = 1000,
                      importance = "impurity") 

vip(model_reduced, geom = "point") + 
  labs(title = "Reduced Model",
       caption = "Variables: pitcher_break_z, pitcher_break_x, avg_speed, spin_rate") +
  theme_bw()


rpart(formula = woba ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate,
     data = model_data_reduced, method = "anova") %>%
  rpart.plot()

```

## Pitch-by-Pitch Breakdowns:

<br>

### Variable Importance Plots {.tabset}
###### Sinkers, Cutters, and Four-Seam Fastballs have been aggregated into a singular "Fastball" category.

#### wOBA {.tabset}
##### Sliders
```{r Slider wOBA VIP, echo = FALSE}

slider_reduced <- Data2 %>% 
  filter(pitch_type == "SL") %>% 
  select(woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, 
         speed_diff) %>% 
  filter(!is.na(spin_rate), !is.na(speed_diff))

slider_model <- ranger(woba ~ ., data = slider_reduced, num.trees = 1000,
                      importance = "impurity") 

vip(slider_model, geom = "point") + 
  labs(title = "Reduced Model",
       caption = "Variables: pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff") +
  theme_bw()

```

##### Fastballs
```{r Fastballs wOBA VIP, echo = FALSE}

fastball_reduced <- Data2 %>% 
  filter(pitch_type == "FC" | pitch_type == "FF" | pitch_type == "SI") %>% 
  select(woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, pitch_type) %>% 
  filter(!is.na(spin_rate))

fastball_model <- ranger(woba ~ ., data = fastball_reduced, num.trees = 1000,
                      importance = "impurity") 

vip(fastball_model, geom = "point") + 
  labs(title = "Reduced Model",
       caption = "Variables: pitcher_break_z, pitcher_break_x, avg_speed, spin_rate") +
  theme_bw()

```

##### Curveballs
```{r Curveballs wOBA VIP, echo = FALSE}
curveball_reduced <- Data2 %>% 
  filter(pitch_type == "CU") %>% 
  select(woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff) %>% 
  filter(!is.na(spin_rate), !is.na(speed_diff))

curveball_model <- ranger(woba ~ ., data = curveball_reduced, num.trees = 1000,
                      importance = "impurity") 

vip(curveball_model, geom = "point") + 
  labs(title = "Reduced Model",
       caption = "Variables: pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff") +
  theme_bw()

```

##### Change-Ups
```{r Change-Ups wOBA VIP, echo = FALSE}
changeup_reduced <- Data2 %>% 
  filter(pitch_type == "CH" | pitch_type == "FS") %>% 
  select(woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff) %>% 
  filter(!is.na(spin_rate), !is.na(speed_diff))

changeup_model <- ranger(woba ~ ., data = changeup_reduced, num.trees = 1000,
                      importance = "impurity") 

vip(changeup_model, geom = "point") + 
  labs(title = "Reduced Model",
       caption = "Variables: pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff") +
  theme_bw()

```

#### {-}

#### xwOBA {.tabset}
##### Sliders
```{r Slider xwOBA VIP, echo = FALSE}

x_slider_reduced <- Data2 %>% 
  filter(pitch_type == "SL") %>% 
  select(est_woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, 
         speed_diff) %>% 
  filter(!is.na(spin_rate), !is.na(speed_diff))

x_slider_model <- ranger(est_woba ~ ., data = x_slider_reduced, num.trees = 1000,
                      importance = "impurity") 

vip(x_slider_model, geom = "point") + 
  labs(title = "Reduced Model",
       caption = "Variables: pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff") +
  theme_bw()

```

##### Fastballs
```{r Fastballs xwOBA VIP, echo = FALSE}

x_fastball_reduced <- Data2 %>% 
  filter(pitch_type == "FC" | pitch_type == "FF" | pitch_type == "SI") %>% 
  select(est_woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, pitch_type) %>% 
  filter(!is.na(spin_rate))

x_fastball_model <- ranger(est_woba ~ ., data = x_fastball_reduced, num.trees = 1000,
                      importance = "impurity") 

vip(x_fastball_model, geom = "point") + 
  labs(title = "Reduced Model",
       caption = "Variables: pitcher_break_z, pitcher_break_x, avg_speed, spin_rate") +
  theme_bw()

```

##### Curveballs
```{r Curveballs xwOBA VIP, echo = FALSE}
x_curveball_reduced <- Data2 %>% 
  filter(pitch_type == "CU") %>% 
  select(est_woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff) %>% 
  filter(!is.na(spin_rate), !is.na(speed_diff))

x_curveball_model <- ranger(est_woba ~ ., data = x_curveball_reduced, num.trees = 1000,
                      importance = "impurity") 

vip(x_curveball_model, geom = "point") + 
  labs(title = "Reduced Model",
       caption = "Variables: pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff") +
  theme_bw()

```

##### Change-Ups
```{r Change-Ups xwOBA VIP, echo = FALSE}
x_changeup_reduced <- Data2 %>% 
  filter(pitch_type == "CH" | pitch_type == "FS") %>% 
  select(est_woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff) %>% 
  filter(!is.na(spin_rate), !is.na(speed_diff))

x_changeup_model <- ranger(est_woba ~ ., data = x_changeup_reduced, num.trees = 1000,
                      importance = "impurity") 

vip(x_changeup_model, geom = "point") + 
  labs(title = "Reduced Model",
       caption = "Variables: pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff") +
  theme_bw()

```

#### {-}

#### Run Value / 100 {.tabset}
##### Sliders
```{r Slider RV VIP, echo = FALSE}

rv_slider_reduced <- Data2 %>% 
  filter(pitch_type == "SL") %>% 
  select(rv100, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, 
         speed_diff) %>% 
  filter(!is.na(spin_rate), !is.na(speed_diff))

rv_slider_model <- ranger(rv100 ~ ., data = rv_slider_reduced, num.trees = 1000,
                      importance = "impurity") 

vip(rv_slider_model, geom = "point") + 
  labs(title = "Reduced Model",
       caption = "Variables: pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff") +
  theme_bw()

```

##### Fastballs
```{r Fastballs RV VIP, echo = FALSE}

rv_fastball_reduced <- Data2 %>% 
  filter(pitch_type == "FC" | pitch_type == "FF" | pitch_type == "SI") %>% 
  select(rv100, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, pitch_type) %>% 
  filter(!is.na(spin_rate))

rv_fastball_model <- ranger(rv100 ~ ., data = rv_fastball_reduced, num.trees = 1000,
                      importance = "impurity") 

vip(rv_fastball_model, geom = "point") + 
  labs(title = "Reduced Model",
       caption = "Variables: pitcher_break_z, pitcher_break_x, avg_speed, spin_rate") +
  theme_bw()

```

##### Curveballs
```{r Curveballs RV VIP, echo = FALSE}
rv_curveball_reduced <- Data2 %>% 
  filter(pitch_type == "CU") %>% 
  select(rv100, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff) %>% 
  filter(!is.na(spin_rate), !is.na(speed_diff))

rv_curveball_model <- ranger(rv100 ~ ., data = rv_curveball_reduced, num.trees = 1000,
                      importance = "impurity") 

vip(rv_curveball_model, geom = "point") + 
  labs(title = "Reduced Model",
       caption = "Variables: pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff") +
  theme_bw()

```

##### Change-Ups
```{r Change-Ups RV VIP, echo = FALSE}
rv_changeup_reduced <- Data2 %>% 
  filter(pitch_type == "CH" | pitch_type == "FS") %>% 
  select(rv100, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff) %>% 
  filter(!is.na(spin_rate), !is.na(speed_diff))

rv_changeup_model <- ranger(rv100 ~ ., data = rv_changeup_reduced, num.trees = 1000,
                      importance = "impurity") 

vip(rv_changeup_model, geom = "point") + 
  labs(title = "Reduced Model",
       caption = "Variables: pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, speed_diff") +
  theme_bw()

```

#### {-}

### {-}


### Decision Trees {.tabset}

#### wOBA {.tabset}
##### Sliders
```{r Sliders wOBA Tree, echo = FALSE}
rpart(formula = woba ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate,
     data = slider_reduced, method = "anova") %>%
  rpart.plot()

```

##### Four-Seams
```{r Four-Seams wOBA Tree, echo = FALSE}
fourseam_reduced <- Data2 %>% 
  filter(pitch_type == "FF") %>% 
  select(woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, pitch_type) %>% 
  filter(!is.na(spin_rate))

rpart(formula = woba ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate + pitch_type,
     data = fourseam_reduced, method = "anova") %>%
  rpart.plot()
```

##### Cutters
```{r Cutters wOBA Tree, echo = FALSE}
cutter_reduced <- Data2 %>% 
  filter(pitch_type == "FC") %>% 
  select(woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, pitch_type) %>% 
  filter(!is.na(spin_rate))

rpart(formula = woba ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate + pitch_type,
     data = cutter_reduced, method = "anova") %>%
  rpart.plot()
```

##### Sinkers
```{r Sinkers wOBA Tree, echo = FALSE}
sinker_reduced <- Data2 %>% 
  filter(pitch_type == "SI") %>% 
  select(woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, pitch_type) %>% 
  filter(!is.na(spin_rate))

rpart(formula = woba ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate + pitch_type,
     data = sinker_reduced, method = "anova") %>%
  rpart.plot()
```

##### Curveballs
```{r Curveballs wOBA Tree, echo = FALSE}

rpart(formula = woba ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate,
     data = curveball_reduced, method = "anova") %>%
  rpart.plot()
```

##### Change-Ups
```{r Change-Ups wOBA Tree, echo = FALSE}

rpart(formula = woba ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate,
     data = changeup_reduced, method = "anova") %>%
  rpart.plot()
```

#### {-}

#### xwOBA {.tabset}
##### Sliders
```{r Sliders xwOBA Tree, echo = FALSE}
rpart(formula = est_woba ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate,
     data = x_slider_reduced, method = "anova") %>%
  rpart.plot()

```

##### Four-Seams
```{r Four-Seams xwOBA Tree, echo = FALSE}
x_fourseam_reduced <- Data2 %>% 
  filter(pitch_type == "FF") %>% 
  select(est_woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, pitch_type) %>% 
  filter(!is.na(spin_rate))

rpart(formula = est_woba ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate + pitch_type,
     data = x_fourseam_reduced, method = "anova") %>%
  rpart.plot()
```

##### Cutters
```{r Cutters xwOBA Tree, echo = FALSE}
x_cutter_reduced <- Data2 %>% 
  filter(pitch_type == "FC") %>% 
  select(est_woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, pitch_type) %>% 
  filter(!is.na(spin_rate))

rpart(formula = est_woba ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate + pitch_type,
     data = x_cutter_reduced, method = "anova") %>%
  rpart.plot()
```

##### Sinkers
```{r Sinkers xwOBA Tree, echo = FALSE}
x_sinker_reduced <- Data2 %>% 
  filter(pitch_type == "SI") %>% 
  select(est_woba, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, pitch_type) %>% 
  filter(!is.na(spin_rate))

rpart(formula = est_woba ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate + pitch_type,
     data = x_sinker_reduced, method = "anova") %>%
  rpart.plot()
```

##### Curveballs
```{r Curveballs xwOBA Tree, echo = FALSE}

rpart(formula = est_woba ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate,
     data = x_curveball_reduced, method = "anova") %>%
  rpart.plot()
```

##### Change-Ups
```{r Change-Ups xwOBA Tree, echo = FALSE}

rpart(formula = est_woba ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate,
     data = x_changeup_reduced, method = "anova") %>%
  rpart.plot()
```

#### {-}

#### Run Value / 100 {.tabset}
##### Sliders
```{r Sliders RV Tree, echo = FALSE}
rpart(formula = rv100 ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate,
     data = rv_slider_reduced, method = "anova") %>%
  rpart.plot()

```

##### Four-Seams
```{r Four-Seams RV Tree, echo = FALSE}
rv_fourseam_reduced <- Data2 %>% 
  filter(pitch_type == "FF") %>% 
  select(rv100, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, pitch_type) %>% 
  filter(!is.na(spin_rate))

rpart(formula = rv100 ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate + pitch_type,
     data = rv_fourseam_reduced, method = "anova") %>%
  rpart.plot()
```

##### Cutters
```{r Cutters RV Tree, echo = FALSE}
rv_cutter_reduced <- Data2 %>% 
  filter(pitch_type == "FC") %>% 
  select(rv100, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, pitch_type) %>% 
  filter(!is.na(spin_rate))

rpart(formula = rv100 ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate + pitch_type,
     data = rv_cutter_reduced, method = "anova") %>%
  rpart.plot()
```

##### Sinkers
```{r Sinkers RV Tree, echo = FALSE}
rv_sinker_reduced <- Data2 %>% 
  filter(pitch_type == "SI") %>% 
  select(rv100, pitcher_break_z, pitcher_break_x, avg_speed, spin_rate, pitch_type) %>% 
  filter(!is.na(spin_rate))

rpart(formula = rv100 ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate + pitch_type,
     data = rv_sinker_reduced, method = "anova") %>%
  rpart.plot()
```

##### Curveballs
```{r Curveballs RV Tree, echo = FALSE}
rpart(formula = rv100 ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate,
     data = rv_curveball_reduced, method = "anova") %>%
  rpart.plot()
```

##### Change-Ups
```{r Change-Ups RV Tree, echo = FALSE}

rpart(formula = rv100 ~ pitcher_break_z + pitcher_break_x + 
                  avg_speed + spin_rate,
     data = rv_changeup_reduced, method = "anova") %>%
  rpart.plot()
```

#### {-}

### {-}


### Pitch Characteristics {.tabset}

#### wOBA {.tabset}
##### Sliders
```{r Sliders wOBA, warning = FALSE, message = FALSE, echo = FALSE}
g_sl_1 <- Data2 %>% 
  filter(pitch_type == "SL") %>% 
  ggplot(aes(x = spin_rate, y = woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  geom_smooth(method = lm, se = FALSE, show.legend = FALSE) + 
  labs(x = "Spin Rate (rpm)",
       y = "wOBA",
       subtitle = "Spin Rate") +
  scale_color_gradient(low = "red", high = "green") +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_x_continuous(labels = scales::comma) +
  theme_dark() +
  theme(plot.subtitle = element_text(hjust = 0.5))

g_sl_2 <- Data2 %>% 
  filter(pitch_type == "SL") %>% 
  ggplot(aes(x = avg_speed, y = woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = lm, se = FALSE) + 
  labs(x = "Average Pitch Speed (mph)",
       y = "",
       color = "Stuff+",
       subtitle = "Speed") +
  scale_y_reverse() +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_color_gradient(low = "red", high = "green") +
  theme_dark()+
  theme(plot.subtitle = element_text(hjust = 0.5),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

grid.arrange(g_sl_1, g_sl_2, ncol = 2, top = "wOBA on Sliders by Spin Rate & Speed")
```

##### Fastballs
```{r Fastballs wOBA, warning = FALSE, message = FALSE, echo = FALSE}
g_fb_1 <- Data2 %>% 
  filter(pitch_type == "FC" | pitch_type == "FF" | pitch_type == "SI") %>% 
  ggplot(aes(x = spin_rate, y = woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  geom_smooth(method = lm, se = FALSE, show.legend = FALSE) + 
  labs(x = "Spin Rate (rpm)",
       y = "wOBA",
       subtitle = "Spin Rate") +
  scale_color_gradient(low = "red", high = "green") +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_x_continuous(labels = scales::comma) +
  theme_dark() +
  theme(plot.subtitle = element_text(hjust = 0.5))

g_fb_2 <- Data2 %>% 
  filter(pitch_type == "FC" | pitch_type == "FF" | pitch_type == "SI") %>% 
  ggplot(aes(x = avg_speed, y = woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = lm, se = FALSE) + 
  labs(x = "Average Pitch Speed (mph)",
       y = "",
       color = "Stuff+",
       subtitle = "Speed") +
  scale_y_reverse() +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_color_gradient(low = "red", high = "green") +
  theme_dark()+
  theme(plot.subtitle = element_text(hjust = 0.5),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

grid.arrange(g_fb_1, g_fb_2, ncol = 2, top = "wOBA on Fastballs by Spin Rate & Speed")
```

##### Curveballs
```{r Curveballs wOBA, warning = FALSE, message = FALSE, echo = FALSE}
g_cu_1 <- Data2 %>% 
  filter(pitch_type == "CU") %>% 
  ggplot(aes(x = spin_rate, y = woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  geom_smooth(method = lm, se = FALSE, show.legend = FALSE) + 
  labs(x = "Spin Rate (rpm)",
       y = "wOBA",
       subtitle = "Spin Rate") +
  scale_color_gradient(low = "red", high = "green") +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_x_continuous(labels = scales::comma) +
  theme_dark() +
  theme(plot.subtitle = element_text(hjust = 0.5))

g_cu_2 <- Data2 %>% 
  filter(pitch_type == "CU") %>% 
  ggplot(aes(x = avg_speed, y = woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = lm, se = FALSE) + 
  labs(x = "Average Pitch Speed (mph)",
       y = "",
       color = "Stuff+",
       subtitle = "Speed") +
  scale_y_reverse() +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_color_gradient(low = "red", high = "green") +
  theme_dark()+
  theme(plot.subtitle = element_text(hjust = 0.5),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

grid.arrange(g_cu_1, g_cu_2, ncol = 2, top = "wOBA on Curveballs by Spin Rate & Speed")
```

##### Change-Ups
```{r Change-Ups wOBA, warning = FALSE, message = FALSE, echo = FALSE}
g_ch_1 <- Data2 %>% 
  filter(pitch_type == "CH" | pitch_type == "FS") %>% 
  ggplot(aes(x = spin_rate, y = woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  geom_smooth(method = lm, se = FALSE, show.legend = FALSE) + 
  labs(x = "Spin Rate (rpm)",
       y = "wOBA",
       subtitle = "Spin Rate") +
  scale_color_gradient(low = "red", high = "green") +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_x_continuous(labels = scales::comma) +
  theme_dark() +
  theme(plot.subtitle = element_text(hjust = 0.5))

g_ch_2 <- Data2 %>% 
  filter(pitch_type == "CH" | pitch_type == "FS") %>% 
  ggplot(aes(x = avg_speed, y = woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = lm, se = FALSE) + 
  labs(x = "Average Pitch Speed (mph)",
       y = "",
       color = "Stuff+",
       subtitle = "Speed") +
  scale_y_reverse() +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_color_gradient(low = "red", high = "green") +
  theme_dark()+
  theme(plot.subtitle = element_text(hjust = 0.5),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

grid.arrange(g_ch_1, g_ch_2, ncol = 2, top = "wOBA on Curveballs by Spin Rate & Speed")
```

#### {-}

#### xwOBA {.tabset}
##### Sliders
```{r Sliders xwOBA, warning = FALSE, message = FALSE, echo = FALSE}
gx_sl_1 <- Data2 %>% 
  filter(pitch_type == "SL") %>% 
  ggplot(aes(x = spin_rate, y = est_woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  geom_smooth(method = lm, se = FALSE, show.legend = FALSE) + 
  labs(x = "Spin Rate (rpm)",
       y = "xwOBA",
       subtitle = "Spin Rate") +
  scale_color_gradient(low = "red", high = "green") +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_x_continuous(labels = scales::comma) +
  theme_dark() +
  theme(plot.subtitle = element_text(hjust = 0.5))

gx_sl_2 <- Data2 %>% 
  filter(pitch_type == "SL") %>% 
  ggplot(aes(x = avg_speed, y = est_woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = lm, se = FALSE) + 
  labs(x = "Average Pitch Speed (mph)",
       y = "",
       color = "Stuff+",
       subtitle = "Speed") +
  scale_y_reverse() +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_color_gradient(low = "red", high = "green") +
  theme_dark()+
  theme(plot.subtitle = element_text(hjust = 0.5),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

grid.arrange(gx_sl_1, gx_sl_2, ncol = 2, top = "xwOBA on Sliders by Spin Rate & Speed")
```

##### Fastballs
```{r Fastballs xwOBA, warning = FALSE, message = FALSE, echo = FALSE}
gx_fb_1 <- Data2 %>% 
  filter(pitch_type == "FC" | pitch_type == "FF" | pitch_type == "SI") %>% 
  ggplot(aes(x = spin_rate, y = est_woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  geom_smooth(method = lm, se = FALSE, show.legend = FALSE) + 
  labs(x = "Spin Rate (rpm)",
       y = "xwOBA",
       subtitle = "Spin Rate") +
  scale_color_gradient(low = "red", high = "green") +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_x_continuous(labels = scales::comma) +
  theme_dark() +
  theme(plot.subtitle = element_text(hjust = 0.5))

gx_fb_2 <- Data2 %>% 
  filter(pitch_type == "FC" | pitch_type == "FF" | pitch_type == "SI") %>% 
  ggplot(aes(x = avg_speed, y = est_woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = lm, se = FALSE) + 
  labs(x = "Average Pitch Speed (mph)",
       y = "",
       color = "Stuff+",
       subtitle = "Speed") +
  scale_y_reverse() +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_color_gradient(low = "red", high = "green") +
  theme_dark()+
  theme(plot.subtitle = element_text(hjust = 0.5),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

grid.arrange(gx_fb_1, gx_fb_2, ncol = 2, top = "xwOBA on Fastballs by Spin Rate & Speed")
```

##### Curveballs
```{r Curveballs xwOBA, warning = FALSE, message = FALSE, echo = FALSE}
gx_cu_1 <- Data2 %>% 
  filter(pitch_type == "CU") %>% 
  ggplot(aes(x = spin_rate, y = est_woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  geom_smooth(method = lm, se = FALSE, show.legend = FALSE) + 
  labs(x = "Spin Rate (rpm)",
       y = "xwOBA",
       subtitle = "Spin Rate") +
  scale_color_gradient(low = "red", high = "green") +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_x_continuous(labels = scales::comma) +
  theme_dark() +
  theme(plot.subtitle = element_text(hjust = 0.5))

gx_cu_2 <- Data2 %>% 
  filter(pitch_type == "CU") %>% 
  ggplot(aes(x = avg_speed, y = est_woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = lm, se = FALSE) + 
  labs(x = "Average Pitch Speed (mph)",
       y = "",
       color = "Stuff+",
       subtitle = "Speed") +
  scale_y_reverse() +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_color_gradient(low = "red", high = "green") +
  theme_dark()+
  theme(plot.subtitle = element_text(hjust = 0.5),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

grid.arrange(gx_cu_1, gx_cu_2, ncol = 2, top = "xwOBA on Curveballs by Spin Rate & Speed")
```

##### Change-Ups
```{r Change-Ups xwOBA, warning = FALSE, message = FALSE, echo = FALSE}
gx_ch_1 <- Data2 %>% 
  filter(pitch_type == "CH" | pitch_type == "FS") %>% 
  ggplot(aes(x = spin_rate, y = est_woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  geom_smooth(method = lm, se = FALSE, show.legend = FALSE) + 
  labs(x = "Spin Rate (rpm)",
       y = "xwOBA",
       subtitle = "Spin Rate") +
  scale_color_gradient(low = "red", high = "green") +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_x_continuous(labels = scales::comma) +
  theme_dark() +
  theme(plot.subtitle = element_text(hjust = 0.5))

gx_ch_2 <- Data2 %>% 
  filter(pitch_type == "CH" | pitch_type == "FS") %>% 
  ggplot(aes(x = avg_speed, y = est_woba, 
             color = `Stf+ Pitch`)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = lm, se = FALSE) + 
  labs(x = "Average Pitch Speed (mph)",
       y = "",
       color = "Stuff+",
       subtitle = "Speed") +
  scale_y_reverse() +
  scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
                     expand = expansion(mult = c(0, 0.05)),
                     trans = "reverse") +
  scale_color_gradient(low = "red", high = "green") +
  theme_dark()+
  theme(plot.subtitle = element_text(hjust = 0.5),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

grid.arrange(gx_ch_1, gx_ch_2, ncol = 2, top = "xwOBA on Change-Ups by Spin Rate & Speed")
```

#### {-}

### {-}

```{r Test, echo = FALSE, eval = FALSE}
# Filtering data
test_data <-  Data2 %>% 
  filter(pitch_type == "SL") %>% 
  filter(!is.na(spin_rate), !is.na(speed_diff)) %>% 
  select(pitcher_id, woba, avg_speed, spin_rate, pitcher_break_x, pitcher_break_z, speed_diff)

# Selecting train/test groups
train_pitcher_id <- test_data %>%
  distinct(pitcher_id) %>%
  slice_sample(prop = 0.7)

test_train <- test_data %>% 
  filter(pitcher_id %in% train_pitcher_id$pitcher_id)

test_test <- test_data %>% 
  filter(!pitcher_id %in% train_pitcher_id$pitcher_id)


# Random forest
test_tune_grid <- expand.grid(mtry = 1:4,
                              splitrule = "variance",
                              min.node.size = 5)

test_caret <- train(woba ~., data = test_train, method = "ranger",
                    num.trees = 10000, 
                    trControl = trainControl(method = "cv", number = 5),
                    tuneGrid = test_tune_grid)

# Scatterplot
test_test %>% 
  mutate(Prediction = predict(test_caret, test_test)) %>% 
  ggplot(aes(x = woba, y = Prediction)) +
  geom_point()

# Correlation
test_test %>% 
  mutate(Prediction = predict(test_caret, test_test)) %>% 
  with(cor(woba, Prediction))

```

```{r Delete Environment, echo = FALSE, eval = FALSE}
rm(g_ch_1)
rm(g_ch_2)
rm(g_cu_1)
rm(g_cu_2)
rm(g_fb_1)
rm(g_fb_2)
rm(g_sl_1)
rm(g_sl_2)

rm(gx_ch_1)
rm(gx_ch_2)
rm(gx_cu_1)
rm(gx_cu_2)
rm(gx_fb_1)
rm(gx_fb_2)
rm(gx_sl_1)
rm(gx_sl_2)

rm(changeup_model)
rm(changeup_reduced)
rm(curveball_model)
rm(curveball_reduced)
rm(slider_model)
rm(slider_reduced)
rm(fastball_model)
rm(fastball_reduced)
rm(fourseam_reduced)
rm(cutter_reduced)
rm(sinker_reduced)

rm(rv_changeup_model)
rm(rv_changeup_reduced)
rm(rv_curveball_model)
rm(rv_curveball_reduced)
rm(rv_slider_model)
rm(rv_slider_reduced)
rm(rv_fastball_model)
rm(rv_fastball_reduced)
rm(rv_fourseam_reduced)
rm(rv_cutter_reduced)
rm(rv_sinker_reduced)

rm(x_changeup_model)
rm(x_changeup_reduced)
rm(x_curveball_model)
rm(x_curveball_reduced)
rm(x_fastball_model)
rm(x_fastball_reduced)
rm(x_slider_model)
rm(x_slider_reduced)
rm(x_fourseam_reduced)
rm(x_cutter_reduced)
rm(x_sinker_reduced)
```

