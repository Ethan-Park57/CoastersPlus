ggplot(aes(x = pitcher_break_z, y = est_woba,
color = `Stf+ Pitch`)) +
geom_point(alpha = 0.7, aes(shape = pitch_type_name), size = 2) +
geom_smooth(method = lm, se = FALSE) +
labs(x = "Vertical Movement (in.)",
y = "",
color = "Stuff+",
shape = "Pitch Type") +
scale_y_reverse() +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
scale_shape_manual(values = c(20, 18)) +
scale_color_gradient(low = "red", high = "green") +
theme_dark()+
theme(plot.subtitle = element_text(hjust = 0.5),
axis.text.y = element_blank(),
axis.ticks.y = element_blank(),
legend.key = element_rect(fill = NA))
grid.arrange(gx2_ch_1, gx2_ch_2, ncol = 2, top = "xwOBA on Change-Ups by Pitch Movement")
# Chunk 68: Four Seams M RV
grv2_ff_1 <- Data2 %>%
filter(pitch_type == "FF") %>%
ggplot(aes(x = pitcher_break_x, y = rv100,
color = `Stf+ Pitch`)) +
geom_point(alpha = 0.7, show.legend = FALSE) +
geom_smooth(method = lm, se = FALSE, show.legend = FALSE) +
labs(x = "Horizontal Movement (in.)",
y = "Run Value / 100") +
scale_color_gradient(low = "red", high = "green") +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
theme_dark() +
theme(plot.subtitle = element_text(hjust = 0.5))
grv2_ff_2 <- Data2 %>%
filter(pitch_type == "FF") %>%
ggplot(aes(x = pitcher_break_z, y = rv100,
color = `Stf+ Pitch`)) +
geom_point(alpha = 0.7) +
geom_smooth(method = lm, se = FALSE) +
labs(x = "Vertical Movement (in.)",
y = "",
color = "Stuff+") +
scale_y_reverse() +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
scale_color_gradient(low = "red", high = "green") +
theme_dark()+
theme(plot.subtitle = element_text(hjust = 0.5),
axis.text.y = element_blank(),
axis.ticks.y = element_blank())
grid.arrange(grv2_ff_1, grv2_ff_2, ncol = 2, top = "Run Value on Four Seam Fastballs by Pitch Movement")
# Chunk 69: Cutters M RV
grv2_fc_1 <- Data2 %>%
filter(pitch_type == "FC") %>%
ggplot(aes(x = pitcher_break_x, y = rv100,
color = `Stf+ Pitch`)) +
geom_point(alpha = 0.7, show.legend = FALSE) +
geom_smooth(method = lm, se = FALSE, show.legend = FALSE) +
labs(x = "Horizontal Movement (in.)",
y = "Run Value / 100") +
scale_color_gradient(low = "red", high = "green") +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
theme_dark() +
theme(plot.subtitle = element_text(hjust = 0.5))
grv2_fc_2 <- Data2 %>%
filter(pitch_type == "FC") %>%
ggplot(aes(x = pitcher_break_z, y = rv100,
color = `Stf+ Pitch`)) +
geom_point(alpha = 0.7) +
geom_smooth(method = lm, se = FALSE) +
labs(x = "Vertical Movement (in.)",
y = "",
color = "Stuff+") +
scale_y_reverse() +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
scale_color_gradient(low = "red", high = "green") +
theme_dark()+
theme(plot.subtitle = element_text(hjust = 0.5),
axis.text.y = element_blank(),
axis.ticks.y = element_blank())
grid.arrange(grv2_fc_1, grv2_fc_2, ncol = 2, top = "Run Value on Cutters by Pitch Movement")
# Chunk 70: Sinkers M RV
grv2_si_1 <- Data2 %>%
filter(pitch_type == "SI") %>%
ggplot(aes(x = pitcher_break_x, y = rv100,
color = `Stf+ Pitch`)) +
geom_point(alpha = 0.7, show.legend = FALSE) +
geom_smooth(method = lm, se = FALSE, show.legend = FALSE) +
labs(x = "Horizontal Movement (in.)",
y = "Run Value / 100") +
scale_color_gradient(low = "red", high = "green") +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
theme_dark() +
theme(plot.subtitle = element_text(hjust = 0.5))
grv2_si_2 <- Data2 %>%
filter(pitch_type == "SI") %>%
ggplot(aes(x = pitcher_break_z, y = rv100,
color = `Stf+ Pitch`)) +
geom_point(alpha = 0.7) +
geom_smooth(method = lm, se = FALSE) +
labs(x = "Vertical Movement (in.)",
y = "",
color = "Stuff+") +
scale_y_reverse() +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
scale_color_gradient(low = "red", high = "green") +
theme_dark()+
theme(plot.subtitle = element_text(hjust = 0.5),
axis.text.y = element_blank(),
axis.ticks.y = element_blank())
grid.arrange(grv2_si_1, grv2_si_2, ncol = 2, top = "Run Value on Sinkers by Pitch Movement")
# Chunk 71: Sliders M RV
grv2_sl_1 <- Data2 %>%
filter(pitch_type == "SL") %>%
ggplot(aes(x = pitcher_break_x, y = rv100,
color = `Stf+ Pitch`)) +
geom_point(alpha = 0.7, show.legend = FALSE) +
geom_smooth(method = lm, se = FALSE, show.legend = FALSE) +
labs(x = "Horizontal Movement (in.)",
y = "Run Value / 100") +
scale_color_gradient(low = "red", high = "green") +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
theme_dark() +
theme(plot.subtitle = element_text(hjust = 0.5))
grv2_sl_2 <- Data2 %>%
filter(pitch_type == "SL") %>%
ggplot(aes(x = pitcher_break_z, y = rv100,
color = `Stf+ Pitch`)) +
geom_point(alpha = 0.7) +
geom_smooth(method = lm, se = FALSE) +
labs(x = "Vertical Movement (in.)",
y = "",
color = "Stuff+") +
scale_y_reverse() +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
scale_color_gradient(low = "red", high = "green") +
theme_dark()+
theme(plot.subtitle = element_text(hjust = 0.5),
axis.text.y = element_blank(),
axis.ticks.y = element_blank())
grid.arrange(grv2_sl_1, grv2_sl_2, ncol = 2, top = "Run Value on Sliders by Pitch Movement")
# Chunk 72: Curveballs M RV
grv2_cu_1 <- Data2 %>%
filter(pitch_type == "CU") %>%
ggplot(aes(x = pitcher_break_x, y = rv100,
color = `Stf+ Pitch`)) +
geom_point(alpha = 0.7, show.legend = FALSE) +
geom_smooth(method = lm, se = FALSE, show.legend = FALSE) +
labs(x = "Horizontal Movement (in.)",
y = "Run Value / 100") +
scale_color_gradient(low = "red", high = "green") +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
theme_dark() +
theme(plot.subtitle = element_text(hjust = 0.5))
grv2_cu_2 <- Data2 %>%
filter(pitch_type == "CU") %>%
ggplot(aes(x = pitcher_break_z, y = rv100,
color = `Stf+ Pitch`)) +
geom_point(alpha = 0.7) +
geom_smooth(method = lm, se = FALSE) +
labs(x = "Vertical Movement (in.)",
y = "",
color = "Stuff+") +
scale_y_reverse() +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
scale_color_gradient(low = "red", high = "green") +
theme_dark()+
theme(plot.subtitle = element_text(hjust = 0.5),
axis.text.y = element_blank(),
axis.ticks.y = element_blank())
grid.arrange(grv2_cu_1, grv2_cu_2, ncol = 2, top = "Run Value on Curveballs by Pitch Movement")
# Chunk 73: Change-Ups M RV
grv2_ch_1 <- Data2 %>%
filter(pitch_type == "CH" | pitch_type == "FS") %>%
ggplot(aes(x = pitcher_break_x, y = rv100,
color = `Stf+ Pitch`)) +
geom_point(alpha = 0.7, show.legend = FALSE, aes(shape = pitch_type_name), size = 2) +
geom_smooth(method = lm, se = FALSE, show.legend = FALSE) +
labs(x = "Horizontal Movement (in.)",
y = "Run Value / 100",
shape = "Pitch Type") +
scale_color_gradient(low = "red", high = "green") +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
scale_shape_manual(values = c(20, 18)) +
theme_dark() +
theme(plot.subtitle = element_text(hjust = 0.5))
grv2_ch_2 <- Data2 %>%
filter(pitch_type == "CH" | pitch_type == "FS") %>%
ggplot(aes(x = pitcher_break_z, y = rv100,
color = `Stf+ Pitch`)) +
geom_point(alpha = 0.7, aes(shape = pitch_type_name), size = 2) +
geom_smooth(method = lm, se = FALSE) +
labs(x = "Vertical Movement (in.)",
y = "",
color = "Stuff+",
shape = "Pitch Type") +
scale_y_reverse() +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
scale_shape_manual(values = c(20, 18)) +
scale_color_gradient(low = "red", high = "green") +
theme_dark()+
theme(plot.subtitle = element_text(hjust = 0.5),
axis.text.y = element_blank(),
axis.ticks.y = element_blank(),
legend.key = element_rect(fill = NA))
grid.arrange(grv2_ch_1, grv2_ch_2, ncol = 2, top = "Run Value on Change-Ups by Pitch Movement")
# Chunk 74: Model 2 GAM / RF CV
# RMSE Function
rmse <- function(observed, predicted){
n <- length(observed)
sqrt(sum((observed - predicted)^2) / n)}
# Folds
groups <- Data2 %>%
select(pitcher_id) %>%
distinct(pitcher_id) %>%
rowwise() %>%
mutate(group = sample(seq(1, 5, 1), 1))
# GAM
data_gam <- Data2 %>%
select(Name, year, pitch_type, pitch_type_name, pitcher_id, avg_speed,
spin_rate, pitcher_break_x, pitcher_break_z, speed_diff, `Stf+ Pitch`,
pitch_per, whiff_percent,
woba, est_woba, rv100) %>%
left_join(groups, by = "pitcher_id") %>%
rename(stf_pitch = `Stf+ Pitch`)
cv <- function(pitch, fold){
cv_d <- data_gam %>% filter(pitch_type == pitch, group != fold)
cv_m <- gam(est_woba ~ s(stf_pitch), data = cv_d, family = gaussian, method = "REML")
cv_p <- data_gam %>% filter(pitch_type == pitch, group == fold)
cv_p <- cv_p %>% mutate(prediction = predict(cv_m, cv_p)) %>%
filter(!is.na(prediction))
}
fourseam <- rbind(cv("FF", "1"),
cv("FF", "2"),
cv("FF", "3"),
cv("FF", "4"),
cv("FF", "5"))
cutter <- rbind(cv("FC", "1"),
cv("FC", "2"),
cv("FC", "3"),
cv("FC", "4"),
cv("FC", "5"))
sinker <- rbind(cv("SI", "1"),
cv("SI", "2"),
cv("SI", "3"),
cv("SI", "4"),
cv("SI", "5"))
cutter <- rbind(cv("FC", "1"),
cv("FC", "2"),
cv("FC", "3"),
cv("FC", "4"),
cv("FC", "5"))
slider <- rbind(cv("SL", "1"),
cv("SL", "2"),
cv("SL", "3"),
cv("SL", "4"),
cv("SL", "5"))
curveball <- rbind(cv("CU", "1"),
cv("CU", "2"),
cv("CU", "3"),
cv("CU", "4"),
cv("CU", "5"))
changeup <- rbind(cv("CH", "1"),
cv("CH", "2"),
cv("CH", "3"),
cv("CH", "4"),
cv("CH", "5"))
gam_pred <- rbind(fourseam, cutter, sinker, slider, curveball, changeup)
gam_pred %>%
ggplot(aes(x = est_woba, y = prediction)) +
geom_point(color = "#FDB827", shape = 18, size = 2.5, alpha = 0.8) +
geom_smooth(se = FALSE, method = lm) +
scale_y_reverse() +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
scale_x_reverse() +
scale_x_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
labs(x = "Observed",
y = "Predicted",
title = "Intra-Pitch (Stuff+) GAM Predictions of xwOBA",
caption = paste("RMSE:",
round(rmse(gam_pred$est_woba, gam_pred$prediction), 4))) +
theme_dark() +
theme(plot.title = element_text(hjust = 0.5))
# Random Forest
data_rf <- data_gam %>%
select(pitch_type, group, est_woba, stf_pitch, avg_speed, spin_rate, pitcher_break_x, pitcher_break_z)
cv_rf <- function(pitch, fold){
cv_d <- data_rf %>% filter(pitch_type == pitch, group != fold) %>%
select(-pitch_type, -group) %>% filter(!is.na(spin_rate), !is.na(stf_pitch))
cv_m <- ranger(est_woba ~ ., data = cv_d, num.trees = 500,
importance = "impurity")
cv_p <- data_rf %>% filter(pitch_type == pitch, group == fold) %>% na.omit() %>% filter(!is.na(spin_rate), !is.na(stf_pitch))
preds <- predict(cv_m, cv_p) %>% as.data.frame()
cv_p %>%
mutate(prediction = preds[,1])
}
fourseam_rf <- rbind(cv_rf("FF", "1"),
cv_rf("FF", "2"),
cv_rf("FF", "3"),
cv_rf("FF", "4"),
cv_rf("FF", "5"))
cutter_rf <- rbind(cv_rf("FC", "1"),
cv_rf("FC", "2"),
cv_rf("FC", "3"),
cv_rf("FC", "4"),
cv_rf("FC", "5"))
sinker_rf <- rbind(cv_rf("SI", "1"),
cv_rf("SI", "2"),
cv_rf("SI", "3"),
cv_rf("SI", "4"),
cv_rf("SI", "5"))
cutter_rf <- rbind(cv_rf("FC", "1"),
cv_rf("FC", "2"),
cv_rf("FC", "3"),
cv_rf("FC", "4"),
cv_rf("FC", "5"))
slider_rf <- rbind(cv_rf("SL", "1"),
cv_rf("SL", "2"),
cv_rf("SL", "3"),
cv_rf("SL", "4"),
cv_rf("SL", "5"))
curveball_rf <- rbind(cv_rf("CU", "1"),
cv_rf("CU", "2"),
cv_rf("CU", "3"),
cv_rf("CU", "4"),
cv_rf("CU", "5"))
changeup_rf <- rbind(cv_rf("CH", "1"),
cv_rf("CH", "2"),
cv_rf("CH", "3"),
cv_rf("CH", "4"),
cv_rf("CH", "5"))
rf_pred <- rbind(fourseam_rf, cutter_rf, sinker_rf, slider_rf,
curveball_rf, changeup_rf)
rf_pred %>%
ggplot(aes(x = est_woba, y = prediction)) +
geom_point(color = "#FDB827", shape = 18, size = 2.5, alpha = 0.8) +
geom_smooth(se = FALSE, method = lm) +
scale_y_reverse() +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
scale_x_reverse() +
scale_x_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
labs(x = "Observed",
y = "Predicted",
title = "Intra-Pitch (Stuff+) Random Forest Predictions of xwOBA",
caption = paste("RMSE:",
round(rmse(rf_pred$est_woba, rf_pred$prediction), 4))) +
theme_dark() +
theme(plot.title = element_text(hjust = 0.5))
rmse(gam_pred$est_woba, gam_pred$prediction)
# Chunk 75: GAM 3 CV
data_gam <- Data2 %>%
mutate(fb_prop = fb_thrown/total_pitches) %>%
mutate(pr = pitch_per/fb_prop) %>%
select(Name, year, pitch_type, pitch_type_name, pitcher_id, avg_speed,
spin_rate, pitcher_break_x, pitcher_break_z, speed_diff, `Stf+ Pitch`,
pitch_per, whiff_percent,
woba, est_woba, rv100, pr, speed_diff, whiff_percent) %>%
left_join(groups, by = "pitcher_id") %>%
rename(stf_pitch = `Stf+ Pitch`)
cv2 <- function(pitch, fold){
cv_d <- data_gam %>% filter(pitch_type == pitch, group != fold)
cv_m <- gam(est_woba ~ s(stf_pitch) + s(speed_diff) + s(pr) + s(whiff_percent),
data = cv_d, family = gaussian, method = "REML")
cv_p <- data_gam %>% filter(pitch_type == pitch, group == fold)
cv_p <- cv_p %>% mutate(prediction = predict(cv_m, cv_p)) %>%
filter(!is.na(prediction))
}
rmse <- function(observed, predicted){
n <- length(observed)
sqrt(sum((observed - predicted)^2) / n)}
fourseam2 <- rbind(cv2("FF", "1"),
cv2("FF", "2"),
cv2("FF", "3"),
cv2("FF", "4"),
cv2("FF", "5"))
cutter2 <- rbind(cv2("FC", "1"),
cv2("FC", "2"),
cv2("FC", "3"),
cv2("FC", "4"),
cv2("FC", "5"))
sinker2 <- rbind(cv2("SI", "1"),
cv2("SI", "2"),
cv2("SI", "3"),
cv2("SI", "4"),
cv2("SI", "5"))
cutter2 <- rbind(cv2("FC", "1"),
cv2("FC", "2"),
cv2("FC", "3"),
cv2("FC", "4"),
cv2("FC", "5"))
slider2 <- rbind(cv2("SL", "1"),
cv2("SL", "2"),
cv2("SL", "3"),
cv2("SL", "4"),
cv2("SL", "5"))
curveball2 <- rbind(cv2("CU", "1"),
cv2("CU", "2"),
cv2("CU", "3"),
cv2("CU", "4"),
cv2("CU", "5"))
changeup2 <- rbind(cv2("CH", "1"),
cv2("CH", "2"),
cv2("CH", "3"),
cv2("CH", "4"),
cv2("CH", "5"))
gam_pred2 <- rbind(fourseam2, cutter2, sinker2, slider2, curveball2, changeup2)
gam_pred2 %>%
ggplot(aes(x = est_woba, y = prediction)) +
geom_point(color = "#FDB827", shape = 18, size = 2.5, alpha = 0.8) +
geom_smooth(se = FALSE, method = lm) +
scale_y_reverse() +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
scale_x_reverse() +
scale_x_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
labs(x = "Observed",
y = "Predicted",
title = "Inter-Pitch GAM Predictions of xwOBA",
caption = paste("RMSE:",
round(rmse(gam_pred2$est_woba, gam_pred2$prediction), 4))) +
theme_dark() +
theme(plot.title = element_text(hjust = 0.5))
rmse(gam_pred$est_woba, gam_pred$prediction)
curveball %>%
ggplot(aes(x = est_woba, y = prediction)) +
geom_point(color = "#FDB827", shape = 18, size = 2.5, alpha = 0.8) +
geom_smooth(se = FALSE, method = lm) +
scale_y_reverse() +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
scale_x_reverse() +
scale_x_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
labs(x = "Observed",
y = "Predicted",
title = "Intra-Pitch GAM Predictions of xwOBA for Curveballs",
caption = paste("RMSE:",
round(rmse(curveball$est_woba, curveball$prediction), 4))) +
theme_dark() +
theme(plot.title = element_text(hjust = 0.5))
curveball2 %>%
ggplot(aes(x = est_woba, y = prediction)) +
geom_point(color = "#FDB827", shape = 18, size = 2.5, alpha = 0.8) +
geom_smooth(se = FALSE, method = lm) +
scale_y_reverse() +
scale_y_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
scale_x_reverse() +
scale_x_continuous(labels = scales::comma_format(accuracy = 0.001),
expand = expansion(mult = c(0, 0.05)),
trans = "reverse") +
labs(x = "Observed",
y = "Predicted",
title = "Inter-Pitch GAM Predictions of xwOBA for Curveballs",
caption = paste0("Inter-Pitch RMSE: ",
round(rmse(curveball2$est_woba, curveball2$prediction), 4),". Intra-Pitch RMSE: ", round(rmse(curveball$est_woba, curveball$prediction), 4))) +
theme_dark() +
theme(plot.title = element_text(hjust = 0.5))
rmse(slider$est_woba, slider$prediction)
rmse(slider2$est_woba, slider2$prediction)
rmse(curveball$est_woba, curveball$prediction)
rmse(curveball2$est_woba, curveball2$prediction)
rmse(fourseam$est_woba, fourseam$prediction)
rmse(fourseam2$est_woba, fourseam2$prediction)
rmse(cutter$est_woba, cutter$prediction)
rmse(cutter2$est_woba, cutter2$prediction)
rmse(changeup$est_woba, changeup$prediction)
rmse(changeup2$est_woba, changeup2$prediction)
rmse(sinker$est_woba, sinker$prediction)
rmse(sinker2$est_woba, sinker2$prediction)
# Chunk 77: Rudimentary Models
Data2 %>%
group_by(pitch_type_name) %>%
summarize(mean(est_woba))
mean(Data2$est_woba)
