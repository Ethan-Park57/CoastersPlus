---
title: "EDA"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("Data.R")
```


```{r message = FALSE}
library(tidyverse)
library(readxl)
library(patchwork)
library(kableExtra)
library(knitr)
```

```{r Slider, message = FALSE, echo = FALSE}
movement_slider_r <- Data %>% 
  filter(pitch_type == "SL") %>% 
  filter(pitch_hand == "R") %>% 
  ggplot() +
  geom_vline(xintercept = 0, color = "black") +
  geom_hline(yintercept = 0, color = "black") +
  geom_point(aes(x = pitcher_break_x, y = pitcher_break_z,
                 color = `Stuff`), alpha = 0.7) +
  scale_y_reverse() +
  scale_color_gradient(low = "blue", high = "red") +
  labs(x = "Horizontal Break",
       y = "Vertical Break",
       title = "Sliders (R)") +
  xlim(40, -40) + ylim(60, -60) +
  theme(axis.title = element_blank(), axis.ticks = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect("white"),
        plot.title = element_text(hjust = 0.5)) + 
  coord_fixed(ratio = 1)
  
movement_slider_l <- Data %>% 
    filter(pitch_type == "SL") %>% 
    filter(pitch_hand == "L") %>% 
  ggplot() +
    geom_vline(xintercept = 0, color = "black") +
    geom_hline(yintercept = 0, color = "black") +
    geom_point(aes(x = pitcher_break_x, y = pitcher_break_z,
                   color = `Stuff`), alpha = 0.7) +
    scale_y_reverse() +
    scale_color_gradient(low = "blue", high = "red") +
    labs(x = "Horizontal Break",
         y = "Vertical Break",
         title = "Sliders (L)") +
    xlim(-40, 40) + ylim(60, -60) +
    theme(axis.title = element_blank(), axis.ticks = element_blank(), 
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_rect("white"),
          plot.title = element_text(hjust = 0.5)) + 
    coord_fixed(ratio = 1)

movement_slider_l + movement_slider_r
rm(movement_slider_l)
rm(movement_slider_r)
```

``` {r Fastball, warning = FALSE, message = FALSE, echo = FALSE}
# 4-Seam Fastball ####
movement_fourseam_r <- Data %>% 
  filter(pitch_type == "FF") %>% 
  filter(pitch_hand == "R") %>% 
  ggplot() +
  geom_vline(xintercept = 0, color = "black") +
  geom_hline(yintercept = 0, color = "black") +
  geom_point(aes(x = pitcher_break_x, y = pitcher_break_z,
                 color = `Stuff`), alpha = 0.7) +
  scale_y_reverse() +
  scale_color_gradient(low = "blue", high = "red") +
  labs(x = "Horizontal Break",
       y = "Vertical Break",
       title = "4-Seam (R)") +
  xlim(-30, 30) + ylim(30, -30) +
  theme(axis.title = element_blank(), axis.ticks = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect("white"),
        plot.title = element_text(hjust = 0.5)) + 
  coord_fixed(ratio = 1)

movement_fourseam_l <- Data %>% 
  filter(pitch_type == "FF") %>% 
  filter(pitch_hand == "L") %>% 
  ggplot() +
  geom_vline(xintercept = 0, color = "black") +
  geom_hline(yintercept = 0, color = "black") +
  geom_point(aes(x = pitcher_break_x, y = pitcher_break_z,
                 color = `Stuff`), alpha = 0.7) +
  scale_y_reverse() +
  scale_color_gradient(low = "blue", high = "red") +
  labs(x = "Horizontal Break",
       y = "Vertical Break",
       title = "Four-Seam (L)") +
  xlim(30, -30) + ylim(30, -30) +
  theme(axis.title = element_blank(), axis.ticks = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect("white"),
        plot.title = element_text(hjust = 0.5)) + 
  coord_fixed(ratio = 1)

movement_fourseam_l + movement_fourseam_r

rm(movement_fourseam_l)
rm(movement_fourseam_r)



Data %>% 
  filter(pitch_type == "FF") %>% 
  filter(pitch_hand == "R") %>% 
  filter(avg_speed >= 94) %>% 
  ggplot() +
  geom_vline(xintercept = 0, color = "black") +
  geom_hline(yintercept = 0, color = "black") +
  geom_point(aes(x = pitcher_break_x, y = pitcher_break_z,
                 color = avg_speed), alpha = 0.75) +
  scale_y_reverse() +
  scale_color_gradient(low = "blue", high = "red") +
  labs(x = "Horizontal Break",
       y = "Vertical Break",
       title = "4-Seam (R)",
       color = "MPH") +
  xlim(-30, 30) + ylim(30, -30) +
  theme(axis.title = element_blank(), axis.ticks = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect("white"),
        plot.title = element_text(hjust = 0.5)) + 
  coord_fixed(ratio = 1)
```

``` {r Pitch Results, message = FALSE, echo = FALSE}
pitches %>% 
  select(result:release_extension) %>% 
  filter(pitches > 9) %>% 
  filter(player_name == "Heaney, Andrew") %>% 
  select(result:pitches, player_name:pitch_percent, woba,
         launch_speed:velocity) %>% 
  filter(pitch_type == "FF") %>% 
  ggplot(aes(x = result, y = woba, fill = pitches)) +
  geom_col() +
  scale_fill_continuous(low = "#FFE338", high = "forestgreen") +
  labs(y = "wOBA",
       x = "Result",
       fill = "# of Pitches",
       title = "Andrew Heaney Batted Balls on 4-Seam Fastballs") +
  theme_classic()


```

```{r, warning = FALSE, message = FALSE, echo = FALSE}
results <- pitches %>% 
  select(-c(pos3_int_start_distance:pos9_int_start_distance))

movement <- Data %>% 
  select(pitch_type, pitch_type_name, Stuff, `Stf+ Pitch`:tail, 
         avg_speed, pitches_thrown, pitch_per, playerID) %>% 
  rename(pitch_prop = pitch_per) %>% 
  filter(!is.na(`Stf+ Pitch`))

movement_league<- movement %>% 
  group_by(pitch_type_name) %>% 
  summarize("horizontal" = 
              weighted.mean(pitcher_break_x, pitches_thrown),
            "vertical" = 
              weighted.mean(pitcher_break_z, pitches_thrown)) %>% 
  as.data.frame()
  
movement_league %>% 
  kable(digits = 2, align = "c",
        col.names = c("Pitch", "Horizontal", "Vertical")) %>% 
  kable_styling(full_width = T)


movement %>% 
    filter(pitch_type == "SL") %>%
  ggplot() +
    geom_vline(xintercept = 0, color = "white") +
    geom_hline(yintercept = 0, color = "white") +
    geom_point(aes(x = pitcher_break_x-movement_league$horizontal, 
                   y = pitcher_break_z-movement_league$vertical,
                   color = `Stf+ Pitch`), alpha = 0.85) +
    scale_y_reverse() +
    scale_color_gradient(low = "aliceblue", high = "dodgerblue3") +
    labs(x = "Horizontal Break",
         y = "Vertical Break",
         title = "Sliders") +
    xlim(-30, 30) + ylim(30, -30) +
    theme(axis.title = element_blank(), axis.ticks = element_blank(), 
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_rect("black"),
          plot.title = element_text(hjust = 0.5)) + 
    coord_fixed(ratio = 1)
```


```{r Exploring Stuff+, echo = FALSE}
movement %>% 
  ggplot(aes(x = `Stf+ Pitch`, color = pitch_type)) +
  geom_histogram(fill = "black", binwidth = 2) +
  labs(x = "Stuff+",
       y = "",
       color = "Pitches") +
  theme_classic()


movement %>% 
  filter(pitch_type == "CU") %>% 
  ggplot(aes(x = `Stf+ Pitch`)) +
  geom_histogram(color = "white", fill = "black", binwidth = 2) +
  labs(x = "Stuff+",
       y = "",
       color = "Pitches") +
  theme_classic()
```

```{r Classification Table, echo = FALSE}
Stf_Class <- c("< 55", "< 70", "< 85", "< 95", " < 105", 
                            "< 115", "< 130", "< 145", "< 160", "â‰¥ 160") %>% 
  cbind(1:10) %>% 
  as.data.frame()
names(Stf_Class) <- c("Stf+ Range", "Class")
Stf_Class <- Stf_Class %>% 
  select(Class, `Stf+ Range`)

Stf_Class %>% 
  kable(caption = "Pitch Classifications for Stuff+") %>% 
  kable_styling(full_width = T)
```

``` {r Classifying Stuff+, echo = FALSE, warning = FALSE, message = FALSE}
movement <- movement %>% 
  mutate(pitch_class = 
           case_when(
             `Stf+ Pitch` < 55 ~ 1,
             `Stf+ Pitch` < 70 ~ 2,
             `Stf+ Pitch` < 85 ~ 3,
             `Stf+ Pitch` < 95 ~ 4,
             `Stf+ Pitch` < 105 ~ 5,
             `Stf+ Pitch` < 115 ~ 6,
             `Stf+ Pitch` < 130 ~ 7,
             `Stf+ Pitch` < 145 ~ 8,
             `Stf+ Pitch` < 160 ~ 9,
             `Stf+ Pitch` >= 160 ~ 10,
    )
  )

movement %>% 
  group_by(pitch_class) %>% 
  summarize(Count = n()) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = pitch_class, y = Count)) + 
  geom_col(color = "black", fill = "forestgreen") +
  geom_label(aes(label = Count), vjust = -0.5,
             color = "forestgreen", fill = "lightgrey") +
  scale_x_continuous(breaks = seq(1, 10, 1)) +
  scale_y_continuous(breaks = seq(0, 600, 100), limits = c(0, 600)) +
  theme_classic() +
  NULL


movement %>% 
    filter(pitch_type == "SL",
           pitch_class > 2) %>%
  ggplot() +
    geom_vline(xintercept = 0, color = "white") +
    geom_hline(yintercept = 0, color = "white") +
    geom_point(aes(x = pitcher_break_x-movement_league$horizontal, 
                   y = pitcher_break_z-movement_league$vertical,
                   color = as.factor(pitch_class)), alpha = 0.85) +
    scale_y_reverse() +
    labs(x = "Horizontal Break",
         y = "Vertical Break",
         title = "Sliders",
         color = "Pitch Class") +
    xlim(-30, 30) + ylim(30, -30) +
    theme(axis.title = element_blank(), axis.ticks = element_blank(), 
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_rect("black"),
          plot.title = element_text(hjust = 0.5)) + 
    coord_fixed(ratio = 1)
```

```{r, echo = FALSE, warning = FALSE, message = FALSE}
pitches <- pitches %>%
  mutate(Type = 
           case_when(
             pitch_type == "CH" ~ "off_speed",
             pitch_type == "FS" ~ "off_speed",
             pitch_type == "SL" ~ "breaking_ball",
             pitch_type == "CU" ~ "breaking_ball",
             pitch_type == "FF" ~ "fastball",
             pitch_type == "FC" ~ "fastball",
             pitch_type == "SI" ~ "fastball"
           )) 
pitches %>%   
  ggplot(aes(x = launch_speed, y = launch_angle, 
             color = result)) +
  geom_point(alpha = 0.7) +
  theme_classic() +
  labs(y = "Launch Angle", x = "Exit Velocity")


movement %>% 
  filter(`Stf+ Pitch` >= 130,
           Stuff > 110,
           pitch_type == "SL" | pitch_type == "CU") %>%
  ggplot() +
    geom_vline(xintercept = 0, color = "white") +
    geom_hline(yintercept = 0, color = "white") +
    geom_point(aes(x = pitcher_break_x-movement_league$horizontal, 
                   y = pitcher_break_z-movement_league$vertical,
                   color = pitch_type), alpha = 0.85) +
    scale_y_reverse() +
    labs(x = "Horizontal Break",
         y = "Vertical Break",
         title = "Above Average Breaking Balls for Above Average Pitchers",
         color = "Pitch") +
    xlim(-20, 20) + ylim(40, -40) +
    theme(axis.title = element_blank(), axis.ticks = element_blank(), 
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_rect("black"),
          plot.title = element_text(hjust = 0.5)) + 
    coord_fixed(ratio = 1)


movement %>% 
  filter(`Stf+ Pitch` >= 130,
           Stuff > 110,
           pitch_type == "FS" | pitch_type == "CH") %>%
  ggplot() +
    geom_vline(xintercept = 0, color = "white") +
    geom_hline(yintercept = 0, color = "white") +
    geom_point(aes(x = pitcher_break_x-movement_league$horizontal, 
                   y = pitcher_break_z-movement_league$vertical,
                   color = pitch_type), alpha = 0.85) +
    scale_y_reverse() +
    labs(x = "Horizontal Break",
         y = "Vertical Break",
         title = "Above Average Off-Speed Pitches for Above Average Pitchers",
         color = "Pitch") +
    xlim(-20, 20) + ylim(20, -20) +
    theme(axis.title = element_blank(), axis.ticks = element_blank(), 
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_rect("black"),
          plot.title = element_text(hjust = 0.5)) + 
    coord_fixed(ratio = 1)


movement %>% 
  filter(`Stf+ Pitch` >= 130,
           Stuff > 110,
           pitch_type == "FF" | pitch_type == "FC" | pitch_type == "SI") %>%
  ggplot() +
    geom_vline(xintercept = 0, color = "white") +
    geom_hline(yintercept = 0, color = "white") +
    geom_point(aes(x = pitcher_break_x-movement_league$horizontal, 
                   y = pitcher_break_z-movement_league$vertical,
                   color = pitch_type), alpha = 0.85) +
    scale_y_reverse() +
    labs(x = "Horizontal Break",
         y = "Vertical Break",
         title = "Above Average Fastballs for Above Average Pitchers",
         color = "Pitch") +
    xlim(-20, 20) + ylim(30, -30) +
    theme(axis.title = element_blank(), axis.ticks = element_blank(), 
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_rect("black"),
          plot.title = element_text(hjust = 0.5)) + 
    coord_fixed(ratio = 1)
```

```{r}
Data2 %>% 
  filter(speed_diff < 0) %>% 
  ggplot(aes(x = speed_diff, y = `Stf+ Pitch`)) +
  geom_hline(yintercept = 100, color = "green", size = 1.25, alpha = 0.3) +
  geom_point(shape = 18, size = 2, alpha = 0.8, aes(color = avg_speed)) +
  geom_smooth(se = FALSE, color = "white", size = 1.5) +
  theme_dark() +
  labs(x = "Speed Differential (vs. Fastball)",
       y = "Pitch Stuff+",
       color = "Pitch Speed") +
  scale_color_gradient(low = "yellow", high = "red", limits = c(70, 100)) +
  scale_x_reverse() +
  theme(panel.grid.minor = element_blank()) +
  NULL
```

